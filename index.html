// Create a sandboxed iframe for ad display
function createAdIframe() {
    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.top = '0';
    iframe.style.left = '0';
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    iframe.style.zIndex = '9999';
    iframe.sandbox = 'allow-scripts allow-same-origin'; // Restrict iframe permissions
    document.body.appendChild(iframe);
    return iframe;
}

// Remove the iframe after ad completion or failure
function removeAdIframe(iframe) {
    if (iframe && iframe.parentNode) {
        iframe.parentNode.removeChild(iframe);
    }
}

// Function to show Monetag In-App Interstitial Ad
function showAd(adType) {
    return new Promise((resolve, reject) => {
        const maxWaitTime = 10000; // 10 seconds
        const startTime = Date.now();

        console.log(`[DEBUG] Attempting to show ad of type: ${adType}`);

        function checkSDK() {
            if (window.show_9180370) {
                console.log("[DEBUG] Monetag SDK loaded, triggering ad...");
                try {
                    switch (adType) {
                        case 'rewarded_popup':
                            console.log("[DEBUG] Triggering 'rewarded_popup' ad in iframe...");
                            // Create a sandboxed iframe
                            const iframe = createAdIframe();
                            // Load the Monetag SDK script inside the iframe
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            const script = iframeDoc.createElement('script');
                            script.src = '//whephiwums.com/sdk.js';
                            script.setAttribute('data-zone', '9180370');
                            script.setAttribute('data-sdk', 'show_9180370');
                            iframeDoc.body.appendChild(script);

                            // Wait for the SDK to load inside the iframe
                            const iframeStartTime = Date.now();
                            function checkIframeSDK() {
                                if (iframe.contentWindow.show_9180370) {
                                    console.log("[DEBUG] Monetag SDK loaded in iframe, showing ad...");
                                    iframe.contentWindow.show_9180370('pop').then(() => {
                                        console.log("[DEBUG] Rewarded popup ad completed successfully in iframe");
                                        removeAdIframe(iframe);
                                        resolve();
                                    }).catch(e => {
                                        console.error("[DEBUG] Rewarded popup failed in iframe:", e.message);
                                        removeAdIframe(iframe);
                                        reject(new Error("Rewarded popup failed: " + e.message));
                                    });
                                } else if (Date.now() - iframeStartTime < maxWaitTime) {
                                    setTimeout(checkIframeSDK, 500);
                                } else {
                                    console.warn("[DEBUG] Monetag SDK failed to load in iframe within 10 seconds");
                                    removeAdIframe(iframe);
                                    reject(new Error("Monetag SDK failed to load in iframe within 10 seconds"));
                                }
                            }
                            checkIframeSDK();
                            break;
                        case 'inApp':
                            console.log("[DEBUG] Triggering 'inApp' interstitial ad...");
                            show_9180370({
                                type: 'inApp',
                                inAppSettings: {
                                    frequency: 2,
                                    capping: 0.1,
                                    interval: 30,
                                    timeout: 5,
                                    everyPage: false
                                }
                            }).then(() => {
                                console.log("[DEBUG] In-app interstitial ad completed successfully");
                                resolve();
                            }).catch(e => {
                                console.error("[DEBUG] In-app interstitial failed:", e.message);
                                reject(new Error("In-app interstitial failed: " + e.message));
                            });
                            break;
                        default:
                            console.error("[DEBUG] Unknown ad type:", adType);
                            reject(new Error("Unknown ad type: " + adType));
                    }
                } catch (error) {
                    console.error("[DEBUG] Failed to show Monetag ad:", error.message);
                    reject(error);
                }
            } else if (Date.now() - startTime < maxWaitTime) {
                console.log("[DEBUG] Monetag SDK not loaded yet, retrying in 500ms...");
                setTimeout(checkSDK, 500); // Check every 500ms
            } else {
                console.warn("[DEBUG] Monetag SDK failed to load within 10 seconds");
                reject(new Error("Monetag SDK failed to load within 10 seconds"));
            }
        }
        checkSDK();
    });
}
